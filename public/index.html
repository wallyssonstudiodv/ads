<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel WhatsApp Bot - Gerenciamento de Anúncios</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status-indicator.connected {
            background: #10b981;
            color: white;
        }

        .status-indicator.disconnected {
            background: #ef4444;
            color: white;
        }

        .status-indicator.connecting {
            background: #f59e0b;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }

        .tab {
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .content-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .qr-container {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .qr-code {
            max-width: 300px;
            margin: 0 auto;
            border-radius: 15px;
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: #e5e7eb;
        }

        .checkbox-item.checked {
            background: #667eea;
            color: white;
        }

        .group-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .group-item:hover {
            background: #f3f4f6;
        }

        .group-item.selected {
            background: #dbeafe;
            border: 2px solid #3b82f6;
        }

        .group-info {
            flex: 1;
        }

        .group-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .group-details {
            color: #666;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #10b981;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 33px;
        }

        .ad-item, .schedule-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .ad-item:hover, .schedule-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .ad-header, .schedule-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .ad-title, .schedule-title {
            font-weight: 600;
            color: #333;
            font-size: 18px;
        }

        .ad-meta, .schedule-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 14px;
        }

        .ad-content {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .ad-actions, .schedule-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .history-item {
            padding: 15px;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 0 10px 10px 0;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-type {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .history-type.connection { background: #10b981; color: white; }
        .history-type.disconnection { background: #ef4444; color: white; }
        .history-type.ad_created { background: #3b82f6; color: white; }
        .history-type.scheduled_send { background: #f59e0b; color: white; }
        .history-type.manual_send { background: #8b5cf6; color: white; }
        .history-type.error { background: #ef4444; color: white; }

        .history-time {
            color: #666;
            font-size: 14px;
        }

        .history-message {
            color: #333;
            margin-bottom: 5px;
        }

        .history-data {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: #f3f4f6;
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            background: #f9fafb;
            transition: all 0.3s ease;
        }

        .file-upload:hover .file-upload-label {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                justify-content: center;
            }
            
            .tab {
                padding: 12px 18px;
                font-size: 14px;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .status-bar {
                justify-content: center;
            }
            
            .ad-actions, .schedule-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fab fa-whatsapp"></i>
                Painel WhatsApp Bot
            </h1>
            <div class="status-bar">
                <div id="connectionStatus" class="status-indicator disconnected">
                    <i class="fas fa-circle"></i>
                    <span>Desconectado</span>
                </div>
                <button id="connectBtn" class="btn btn-primary">
                    <i class="fas fa-plug"></i>
                    Conectar
                </button>
                <button id="refreshBtn" class="btn btn-info">
                    <i class="fas fa-sync"></i>
                    Atualizar
                </button>
            </div>
        </div>

        <!-- Estatísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number" id="groupsCount">0</div>
                <div class="stat-label">Grupos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bullhorn"></i>
                </div>
                <div class="stat-number" id="adsCount">0</div>
                <div class="stat-label">Anúncios</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar"></i>
                </div>
                <div class="stat-number" id="schedulesCount">0</div>
                <div class="stat-label">Agendamentos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="stat-number" id="historyCount">0</div>
                <div class="stat-label">Histórico</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="connection">
                <i class="fas fa-qrcode"></i>
                Conexão
            </div>
            <div class="tab" data-tab="groups">
                <i class="fas fa-users"></i>
                Grupos
            </div>
            <div class="tab" data-tab="ads">
                <i class="fas fa-bullhorn"></i>
                Anúncios
            </div>
            <div class="tab" data-tab="schedules">
                <i class="fas fa-calendar"></i>
                Agendamentos
            </div>
            <div class="tab" data-tab="history">
                <i class="fas fa-history"></i>
                Histórico
            </div>
        </div>

        <!-- Connection Section -->
        <div id="connection-section" class="content-section active">
            <div class="card">
                <h3>
                    <i class="fas fa-qrcode"></i>
                    Conexão WhatsApp
                </h3>
                <div id="connectionContent">
                    <p>Clique em "Conectar" para iniciar a conexão com o WhatsApp.</p>
                    <div id="qrContainer" class="qr-container" style="display: none;">
                        <h4>Escaneie o QR Code com seu WhatsApp</h4>
                        <p style="margin: 15px 0; color: #666;">
                            Abra o WhatsApp > Menu (3 pontos) > Dispositivos conectados > Conectar um dispositivo
                        </p>
                        <canvas id="qrCanvas" class="qr-code"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Groups Section -->
        <div id="groups-section" class="content-section">
            <div class="grid grid-2">
                <div class="card">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                        <h3>
                            <i class="fas fa-users"></i>
                            Meus Grupos
                        </h3>
                        <button id="refreshGroupsBtn" class="btn btn-info">
                            <i class="fas fa-sync"></i>
                            Atualizar
                        </button>
                    </div>
                    <div id="groupsList">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Conecte o bot para carregar seus grupos
                        </p>
                    </div>
                </div>
                <div class="card">
                    <h3>
                        <i class="fas fa-cog"></i>
                        Configurações
                    </h3>
                    <div class="form-group">
                        <label>Grupos Selecionados</label>
                        <div id="selectedGroupsInfo" style="padding: 15px; background: #f3f4f6; border-radius: 10px;">
                            Nenhum grupo selecionado
                        </div>
                    </div>
                    <button id="selectAllGroupsBtn" class="btn btn-primary" style="margin-right: 10px;">
                        <i class="fas fa-check-double"></i>
                        Selecionar Todos
                    </button>
                    <button id="deselectAllGroupsBtn" class="btn btn-warning">
                        <i class="fas fa-times"></i>
                        Desmarcar Todos
                    </button>
                </div>
            </div>
        </div>

        <!-- Ads Section -->
        <div id="ads-section" class="content-section">
            <div class="grid grid-2">
                <div class="card">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                        <h3>
                            <i class="fas fa-bullhorn"></i>
                            Meus Anúncios
                        </h3>
                        <button id="newAdBtn" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Novo Anúncio
                        </button>
                    </div>
                    <div id="adsList">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Nenhum anúncio criado ainda
                        </p>
                    </div>
                </div>
                <div class="card">
                    <h3>
                        <i class="fas fa-paper-plane"></i>
                        Envio Rápido
                    </h3>
                    <div class="form-group">
                        <label for="quickSendAd">Selecionar Anúncio</label>
                        <select id="quickSendAd" class="form-control">
                            <option value="">Escolha um anúncio</option>
                        </select>
                    </div>
                    <button id="sendNowBtn" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i>
                        Enviar Agora
                    </button>
                </div>
            </div>
        </div>

        <!-- Schedules Section -->
        <div id="schedules-section" class="content-section">
            <div class="grid grid-2">
                <div class="card">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                        <h3>
                            <i class="fas fa-calendar"></i>
                            Agendamentos
                        </h3>
                        <button id="newScheduleBtn" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Novo Agendamento
                        </button>
                    </div>
                    <div id="schedulesList">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Nenhum agendamento criado ainda
                        </p>
                    </div>
                </div>
                <div class="card">
                    <h3>
                        <i class="fas fa-info-circle"></i>
                        Próximos Envios
                    </h3>
                    <div id="nextSends">
                        <p style="text-align: center; color: #666; padding: 20px;">
                            Nenhum envio programado
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="history-section" class="content-section">
            <div class="card">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h3>
                        <i class="fas fa-history"></i>
                        Histórico de Atividades
                    </h3>
                    <button id="clearHistoryBtn" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                        Limpar Histórico
                    </button>
                </div>
                <div id="historyList">
                    <p style="text-align: center; color: #666; padding: 20px;">
                        Nenhuma atividade registrada
                    </p>
                </div>
                <div id="historyPagination" style="text-align: center; margin-top: 20px;">
                    <!-- Paginação será inserida aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Anúncio -->
    <div id="adModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Criar/Editar Anúncio</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="adForm">
                <div class="form-group">
                    <label>Tipo de Anúncio</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" data-value="text">
                            <input type="radio" name="adType" value="text" checked>
                            <i class="fas fa-font"></i>
                            Texto
                        </div>
                        <div class="checkbox-item" data-value="image">
                            <input type="radio" name="adType" value="image">
                            <i class="fas fa-image"></i>
                            Imagem
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="adTitle">Título do Anúncio</label>
                    <input type="text" id="adTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="adContent">Conteúdo</label>
                    <textarea id="adContent" class="form-control" rows="5" placeholder="Digite o texto do seu anúncio..." required></textarea>
                </div>
                <div class="form-group" id="imageUploadGroup" style="display: none;">
                    <label>Imagem</label>
                    <div class="file-upload">
                        <input type="file" id="adImage" accept="image/*">
                        <div class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Clique para selecionar uma imagem</span>
                        </div>
                    </div>
                    <img id="imagePreview" class="preview-image" style="display: none;">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Salvar Anúncio
                    </button>
                    <button type="button" class="btn btn-danger close-modal">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Agendamento -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Criar/Editar Agendamento</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="scheduleForm">
                <div class="form-group">
                    <label for="scheduleName">Nome do Agendamento</label>
                    <input type="text" id="scheduleName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="scheduleAd">Anúncio</label>
                    <select id="scheduleAd" class="form-control" required>
                        <option value="">Selecione um anúncio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Dias da Semana</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" data-value="monday">
                            <input type="checkbox" name="scheduleDays" value="monday">
                            Segunda
                        </div>
                        <div class="checkbox-item" data-value="tuesday">
                            <input type="checkbox" name="scheduleDays" value="tuesday">
                            Terça
                        </div>
                        <div class="checkbox-item" data-value="wednesday">
                            <input type="checkbox" name="scheduleDays" value="wednesday">
                            Quarta
                        </div>
                        <div class="checkbox-item" data-value="thursday">
                            <input type="checkbox" name="scheduleDays" value="thursday">
                            Quinta
                        </div>
                        <div class="checkbox-item" data-value="friday">
                            <input type="checkbox" name="scheduleDays" value="friday">
                            Sexta
                        </div>
                        <div class="checkbox-item" data-value="saturday">
                            <input type="checkbox" name="scheduleDays" value="saturday">
                            Sábado
                        </div>
                        <div class="checkbox-item" data-value="sunday">
                            <input type="checkbox" name="scheduleDays" value="sunday">
                            Domingo
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="scheduleTime">Horário</label>
                    <input type="time" id="scheduleTime" class="form-control" required>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Salvar Agendamento
                    </button>
                    <button type="button" class="btn btn-danger close-modal">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script>
        class WhatsAppPanel {
            constructor() {
                this.socket = io();
                this.currentTab = 'connection';
                this.currentPage = 1;
                this.editingAd = null;
                this.editingSchedule = null;
                
                this.initializeEventListeners();
                this.loadInitialData();
            }
            
            initializeEventListeners() {
                // Socket events
                this.socket.on('connectionStatus', (data) => {
                    this.updateConnectionStatus(data);
                });
                
                this.socket.on('dataUpdated', (data) => {
                    this.handleDataUpdate(data);
                });
                
                this.socket.on('newHistoryEntry', (entry) => {
                    this.addHistoryEntry(entry);
                });
                
                // Tab navigation
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchTab(tab.dataset.tab);
                    });
                });
                
                // Connection buttons
                document.getElementById('connectBtn').addEventListener('click', () => {
                    this.connectBot();
                });
                
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshData();
                });
                
                // Groups
                document.getElementById('refreshGroupsBtn').addEventListener('click', () => {
                    this.refreshGroups();
                });
                
                document.getElementById('selectAllGroupsBtn').addEventListener('click', () => {
                    this.selectAllGroups(true);
                });
                
                document.getElementById('deselectAllGroupsBtn').addEventListener('click', () => {
                    this.selectAllGroups(false);
                });
                
                // Ads
                document.getElementById('newAdBtn').addEventListener('click', () => {
                    this.openAdModal();
                });
                
                document.getElementById('sendNowBtn').addEventListener('click', () => {
                    this.sendAdNow();
                });
                
                // Schedules
                document.getElementById('newScheduleBtn').addEventListener('click', () => {
                    this.openScheduleModal();
                });
                
                // History
                document.getElementById('clearHistoryBtn').addEventListener('click', () => {
                    this.clearHistory();
                });
                
                // Modals
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.closeModals();
                    });
                });
                
                // Forms
                document.getElementById('adForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveAd();
                });
                
                document.getElementById('scheduleForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSchedule();
                });
                
                // Ad type change
                document.querySelectorAll('input[name="adType"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.toggleImageUpload();
                    });
                });
                
                // Image preview
                document.getElementById('adImage').addEventListener('change', (e) => {
                    this.previewImage(e.target.files[0]);
                });
                
                // Checkbox groups
                document.querySelectorAll('.checkbox-group').forEach(group => {
                    group.addEventListener('click', (e) => {
                        if (e.target.closest('.checkbox-item')) {
                            this.toggleCheckboxItem(e.target.closest('.checkbox-item'));
                        }
                    });
                });
            }
            
            async loadInitialData() {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    
                    this.updateConnectionStatus({
                        connected: data.connected,
                        qrCode: data.qrCode
                    });
                    
                    this.updateStats(data.stats);
                    
                    // Load all data
                    await this.loadGroups();
                    await this.loadAds();
                    await this.loadSchedules();
                    await this.loadHistory();
                    
                } catch (error) {
                    console.error('Erro ao carregar dados iniciais:', error);
                    this.showAlert('Erro ao carregar dados iniciais', 'error');
                }
            }
            
            updateConnectionStatus(data) {
                const statusEl = document.getElementById('connectionStatus');
                const connectBtn = document.getElementById('connectBtn');
                const qrContainer = document.getElementById('qrContainer');
                
                if (data.connected) {
                    statusEl.className = 'status-indicator connected';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Conectado</span>';
                    connectBtn.innerHTML = '<i class="fas fa-unlink"></i>Desconectar';
                    connectBtn.onclick = () => this.disconnectBot();
                    qrContainer.style.display = 'none';
                } else if (data.qrCode) {
                    statusEl.className = 'status-indicator connecting';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Conectando...</span>';
                    connectBtn.innerHTML = '<i class="fas fa-spinner loading"></i>Conectando...';
                    connectBtn.disabled = true;
                    this.showQRCode(data.qrCode);
                } else {
                    statusEl.className = 'status-indicator disconnected';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Desconectado</span>';
                    connectBtn.innerHTML = '<i class="fas fa-plug"></i>Conectar';
                    connectBtn.disabled = false;
                    connectBtn.onclick = () => this.connectBot();
                    qrContainer.style.display = 'none';
                }
            }
            
            showQRCode(qrData) {
                const canvas = document.getElementById('qrCanvas');
                const container = document.getElementById('qrContainer');
                
                QRCode.toCanvas(canvas, qrData, {
                    width: 300,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                });
                
                container.style.display = 'block';
            }
            
            updateStats(stats) {
                document.getElementById('groupsCount').textContent = stats.groups || 0;
                document.getElementById('adsCount').textContent = stats.ads || 0;
                document.getElementById('schedulesCount').textContent = stats.schedules || 0;
                document.getElementById('historyCount').textContent = stats.history || 0;
            }
            
            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Update content sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(`${tabName}-section`).classList.add('active');
                
                this.currentTab = tabName;
            }
            
            async connectBot() {
                try {
                    const response = await fetch('/api/connect', { method: 'POST' });
                    const data = await response.json();
                    this.showAlert(data.message, 'info');
                } catch (error) {
                    this.showAlert('Erro ao conectar bot', 'error');
                }
            }
            
            async disconnectBot() {
                try {
                    const response = await fetch('/api/disconnect', { method: 'POST' });
                    const data = await response.json();
                    this.showAlert(data.message, 'info');
                } catch (error) {
                    this.showAlert('Erro ao desconectar bot', 'error');
                }
            }
            
            async refreshData() {
                await this.loadInitialData();
                this.showAlert('Dados atualizados com sucesso', 'success');
            }
            
            async loadGroups() {
                try {
                    const response = await fetch('/api/groups');
                    const groups = await response.json();
                    this.renderGroups(groups);
                } catch (error) {
                    console.error('Erro ao carregar grupos:', error);
                }
            }
            
            renderGroups(groups) {
                const container = document.getElementById('groupsList');
                const selectedInfo = document.getElementById('selectedGroupsInfo');
                
                if (Object.keys(groups).length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nenhum grupo encontrado</p>';
                    selectedInfo.textContent = 'Nenhum grupo selecionado';
                    return;
                }
                
                let html = '';
                let selectedCount = 0;
                
                Object.values(groups).forEach(group => {
                    const selected = group.selected ? 'selected' : '';
                    if (group.selected) selectedCount++;
                    
                    html += `
                        <div class="group-item ${selected}" data-group-id="${group.id}">
                            <div class="group-info">
                                <div class="group-name">${group.name}</div>
                                <div class="group-details">
                                    <i class="fas fa-users"></i> ${group.participants} participantes
                                </div>
                            </div>
                            <div class="toggle-switch ${group.selected ? 'active' : ''}" 
                                 onclick="panel.toggleGroup('${group.id}')">
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                selectedInfo.textContent = `${selectedCount} grupo(s) selecionado(s)`;
            }
            
            async toggleGroup(groupId) {
                try {
                    const response = await fetch(`/api/groups/${groupId}/toggle`, { method: 'POST' });
                    if (response.ok) {
                        await this.loadGroups();
                    }
                } catch (error) {
                    this.showAlert('Erro ao alterar seleção do grupo', 'error');
                }
            }
            
            async refreshGroups() {
                try {
                    const response = await fetch('/api/groups/refresh', { method: 'POST' });
                    const data = await response.json();
                    this.showAlert(data.message, 'success');
                    await this.loadGroups();
                } catch (error) {
                    this.showAlert('Erro ao atualizar grupos', 'error');
                }
            }
            
            async selectAllGroups(select) {
                try {
                    const groups = await fetch('/api/groups').then(r => r.json());
                    
                    const promises = Object.keys(groups).map(groupId => {
                        if (groups[groupId].selected !== select) {
                            return fetch(`/api/groups/${groupId}/toggle`, { method: 'POST' });
                        }
                    }).filter(Boolean);
                    
                    await Promise.all(promises);
                    await this.loadGroups();
                    
                    this.showAlert(select ? 'Todos os grupos foram selecionados' : 'Todos os grupos foram desmarcados', 'success');
                } catch (error) {
                    this.showAlert('Erro ao alterar seleção dos grupos', 'error');
                }
            }
            
            async loadAds() {
                try {
                    const response = await fetch('/api/ads');
                    const ads = await response.json();
                    this.renderAds(ads);
                    this.updateAdSelects(ads);
                } catch (error) {
                    console.error('Erro ao carregar anúncios:', error);
                }
            }
            
            renderAds(ads) {
                const container = document.getElementById('adsList');
                
                if (Object.keys(ads).length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nenhum anúncio criado ainda</p>';
                    return;
                }
                
                let html = '';
                
                Object.values(ads).forEach(ad => {
                    const typeIcon = ad.type === 'image' ? 'fas fa-image' : 'fas fa-font';
                    const statusClass = ad.isActive ? 'success' : 'danger';
                    const statusText = ad.isActive ? 'Ativo' : 'Inativo';
                    
                    html += `
                        <div class="ad-item">
                            <div class="ad-header">
                                <div class="ad-title">${ad.title}</div>
                                <span class="btn btn-${statusClass}" style="font-size: 12px; padding: 5px 10px;">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="ad-meta">
                                <div class="meta-item">
                                    <i class="${typeIcon}"></i>
                                    ${ad.type === 'image' ? 'Imagem' : 'Texto'}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    ${new Date(ad.createdAt).toLocaleDateString('pt-BR')}
                                </div>
                            </div>
                            <div class="ad-content">
                                ${ad.content.substring(0, 100)}${ad.content.length > 100 ? '...' : ''}
                            </div>
                            ${ad.type === 'image' && ad.imagePath ? `
                                <img src="${ad.imagePath}" class="preview-image" style="margin-bottom: 15px;">
                            ` : ''}
                            <div class="ad-actions">
                                <button class="btn btn-info" onclick="panel.editAd('${ad.id}')">
                                    <i class="fas fa-edit"></i>
                                    Editar
                                </button>
                                <button class="btn btn-${ad.isActive ? 'warning' : 'success'}" onclick="panel.toggleAd('${ad.id}')">
                                    <i class="fas fa-${ad.isActive ? 'pause' : 'play'}"></i>
                                    ${ad.isActive ? 'Desativar' : 'Ativar'}
                                </button>
                                <button class="btn btn-primary" onclick="panel.sendAdNow('${ad.id}')">
                                    <i class="fas fa-paper-plane"></i>
                                    Enviar
                                </button>
                                <button class="btn btn-danger" onclick="panel.deleteAd('${ad.id}')">
                                    <i class="fas fa-trash"></i>
                                    Deletar
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            updateAdSelects(ads) {
                const quickSendSelect = document.getElementById('quickSendAd');
                const scheduleAdSelect = document.getElementById('scheduleAd');
                
                [quickSendSelect, scheduleAdSelect].forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Selecione um anúncio</option>';
                    
                    Object.values(ads).forEach(ad => {
                        if (ad.isActive) {
                            const option = document.createElement('option');
                            option.value = ad.id;
                            option.textContent = ad.title;
                            if (ad.id === currentValue) option.selected = true;
                            select.appendChild(option);
                        }
                    });
                });
            }
            
            openAdModal(adId = null) {
                const modal = document.getElementById('adModal');
                const form = document.getElementById('adForm');
                
                form.reset();
                this.editingAd = adId;
                
                if (adId) {
                    // Load ad data for editing
                    fetch(`/api/ads`)
                        .then(r => r.json())
                        .then(ads => {
                            const ad = ads[adId];
                            if (ad) {
                                document.getElementById('adTitle').value = ad.title;
                                document.getElementById('adContent').value = ad.content;
                                document.querySelector(`input[name="adType"][value="${ad.type}"]`).checked = true;
                                this.toggleImageUpload();
                                
                                if (ad.type === 'image' && ad.imagePath) {
                                    const preview = document.getElementById('imagePreview');
                                    preview.src = ad.imagePath;
                                    preview.style.display = 'block';
                                }
                            }
                        });
                }
                
                this.toggleImageUpload();
                modal.classList.add('active');
            }
            
            toggleImageUpload() {
                const imageGroup = document.getElementById('imageUploadGroup');
                const isImageType = document.querySelector('input[name="adType"]:checked').value === 'image';
                imageGroup.style.display = isImageType ? 'block' : 'none';
            }
            
            previewImage(file) {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('imagePreview');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            async saveAd() {
                try {
                    const formData = new FormData();
                    formData.append('type', document.querySelector('input[name="adType"]:checked').value);
                    formData.append('title', document.getElementById('adTitle').value);
                    formData.append('content', document.getElementById('adContent').value);
                    
                    const imageFile = document.getElementById('adImage').files[0];
                    if (imageFile) {
                        formData.append('image', imageFile);
                    }
                    
                    const url = this.editingAd ? `/api/ads/${this.editingAd}` : '/api/ads';
                    const method = this.editingAd ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(data.message, 'success');
                        this.closeModals();
                        await this.loadAds();
                    } else {
                        this.showAlert(data.error || 'Erro ao salvar anúncio', 'error');
                    }
                } catch (error) {
                    this.showAlert('Erro ao salvar anúncio', 'error');
                }
            }
            
            async editAd(adId) {
                this.openAdModal(adId);
            }
            
            async toggleAd(adId) {
                try {
                    const response = await fetch(`/api/ads/${adId}/toggle`, { method: 'POST' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(data.message, 'success');
                        await this.loadAds();
                    } else {
                        this.showAlert(data.error || 'Erro ao alterar status do anúncio', 'error');
                    }
                } catch (error) {
                    this.showAlert('Erro ao alterar status do anúncio', 'error');
                }
            }
            
            async deleteAd(adId) {
                if (!confirm('Tem certeza que deseja deletar este anúncio?')) return;
                
                try {
                    const response = await fetch(`/api/ads/${adId}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(data.message, 'success');
                        await this.loadAds();
                    } else {
                        this.showAlert(data.error || 'Erro ao deletar anúncio', 'error');
                    }
                } catch (error) {
                    this.showAlert('Erro ao deletar anúncio', 'error');
                }
            }
            
            async sendAdNow(adId = null) {
                const targetAdId = adId || document.getElementById('quickSendAd').value;
                
                if (!targetAdId) {
                    this.showAlert('Selecione um anúncio para enviar', 'warning');
                    return;
                }
                
                if (!confirm('Tem certeza que deseja enviar este anúncio agora para todos os grupos selecionados?')) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/send-now', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ adId: targetAdId })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(`Anúncio enviado! Sucesso: ${data.result.success}, Falhas: ${data.result.failed}`, 'success');
                    } else {
                        this.showAlert(data.error || 'Erro ao enviar anúncio', 'error');
                    }
                } catch (error) {
                    this.showAlert('Erro ao enviar anúncio', 'error');
                }
            }
            
            async loadSchedules() {
                try {
                    const response = await fetch('/api/schedules');
                    const schedules = await response.json();
                    this.renderSchedules(schedules);
                    this.renderNextSends(schedules);
                } catch (error) {
                    console.error('Erro ao carregar agendamentos:', error);
                }
            }
            
            renderSchedules(schedules) {
                const container = document.getElementById('schedulesList');
                
                if (Object.keys(schedules).length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nenhum agendamento criado ainda</p>';
                    return;
                }
                
                let html = '';
                
                Object.values(schedules).forEach(schedule => {
                    const statusClass = schedule.isActive ? 'success' : 'danger';
                    const statusText = schedule.isActive ? 'Ativo' : 'Inativo';
                    const nextRun = schedule.nextRun ? new Date(schedule.nextRun).toLocaleString('pt-BR') : 'N/A';
                    const lastRun = schedule.lastRun ? new Date(schedule.lastRun).toLocaleString('pt-BR') : 'Nunca';
                    
                    const daysText = schedule.days.map(day => {
                        const dayNames = {
                            'monday': 'Seg', 'tuesday': 'Ter', 'wednesday': 'Qua',
                            'thursday': 'Qui', 'friday': 'Sex', 'saturday': 'Sáb', 'sunday': 'Dom'
                        };
                        return dayNames[day];
                    }).join(', ');
                    
                    html += `
                        <div class="schedule-item">
                            <div class="schedule-header">
                                <div class="schedule-title">${schedule.name}</div>
                                <span class="btn btn-${statusClass}" style="font-size: 12px; padding: 5px 10px;">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="schedule-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    ${daysText}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-clock"></i>
                                    ${schedule.time}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-play"></i>
                                    Próximo: ${nextRun}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-history"></i>
                                    Último: ${lastRun}
                                </div>
                            </div>
                            <div class="schedule-actions">
                                <button class="btn btn-info" onclick="panel.editSchedule('${schedule.id}')">
                                    <i class="fas fa-edit"></i>
                                    Editar
                                </button>
                                <button class="btn btn-${schedule.isActive ? 'warning' : 'success'}" onclick="panel.toggleSchedule('${schedule.id}')">
                                    <i class="fas fa-${schedule.isActive ? 'pause' : 'play'}"></i>
                                    ${schedule.isActive ? 'Desativar' : 'Ativar'}
                                </button>
                                <button class="btn btn-danger" onclick="panel.deleteSchedule('${schedule.id}')">
                                    <i class="fas fa-trash"></i>
                                    Deletar
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            renderNextSends(schedules) {
                const container = document.getElementById('nextSends');
                
                const activeSchedules = Object.values(schedules)
                    .filter(s => s.isActive && s.nextRun)
                    .sort((a, b) => new Date(a.nextRun) - new Date(b.nextRun))
                    .slice(0, 5);
                
                if (activeSchedules.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nenhum envio programado</p>';
                    return;
                }
                
                let html = '';
                activeSchedules.forEach(schedule => {
                    const nextRun = new Date(schedule.nextRun);
                    const now = new Date();
                    const diff = nextRun - now;
                    
                    let timeLeft = '';
                    if (diff > 0) {
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        timeLeft = `${hours}h ${minutes}m`;
                    } else {
                        timeLeft = 'Agora';
                    }
                    
                    html += `
                        <div style="padding: 10px; border-left: 3px solid #667eea; margin-bottom: 10px; background: #f9fafb;">
                            <div style="font-weight: 600; color: #333;">${schedule.name}</div>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                <i class="fas fa-clock"></i> ${nextRun.toLocaleString('pt-BR')}
                                <span style="color: #667eea; font-weight: 600; margin-left: 10px;">em ${timeLeft}</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            openScheduleModal(scheduleId = null) {
                const modal = document.getElementById('scheduleModal');
                const form = document.getElementById('scheduleForm');
                
                form.reset();
                this.editingSchedule = scheduleId;
                
                // Reset checkbox items
                document.querySelectorAll('#scheduleModal .checkbox-item').forEach(item => {
                    item.classList.remove('checked');
                    item.querySelector('input').checked = false;
                });
                
                if (scheduleId) {
                    // Load schedule data for editing
                    fetch(`/api/schedules`)
                        .then(r => r.json())
                        .then(schedules => {
                            const schedule = schedules[scheduleId];
                            if (schedule) {
                                document.getElementById('scheduleName').value = schedule.name;
                                document.getElementById('scheduleAd').value = schedule.adId;
                                document.getElementById('scheduleTime').value = schedule.time;
                                
                                schedule.days.forEach(day => {
                                    const checkbox = document.querySelector(`input[name="scheduleDays"][value="${day}"]`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                        checkbox.closest('.checkbox-item').classList.add('checked');
                                    }
                                });
                            }
                        });
                }
                
                modal.classList.add('active');
            }
            
            async saveSchedule() {
                try {
                    const selectedDays = Array.from(document.querySelectorAll('input[name="scheduleDays"]:checked'))
                        .map(checkbox => checkbox.value);
                    
                    if (selectedDays.length === 0) {
                        this.showAlert('Selecione pelo menos um dia da semana', 'warning');
                        return;
                    }
                    
                    const scheduleData = {
                        name: document.getElementById('scheduleName').value,
                        adId: document.getElementById('scheduleAd').value,
                        days: selectedDays,
                        time: document.getElementById('scheduleTime').value,
                        isActive: true
                    };
                    
                    const url = this.editingSchedule ? `/api/schedules/${this.editingSchedule}` : '/api/schedules';
                    const method = this.editingSchedule ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(scheduleData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(data.message, 'success');
                        this.closeModals();
                        await this.loadSchedules();
                    } else {
                        this.showAlert(data.error || 'Erro ao salvar agendamento', 'error');
                    }
                } catch (error) {
                    this.showAlert('Erro ao salvar agendamento', 'error');
                }
            }
            
            async editSchedule(scheduleId) {
                this.openScheduleModal(scheduleId);
            }
            
            async toggleSchedule(scheduleId) {
                try {
                    const response = await fetch(`/api/schedules/${scheduleId}/toggle`, { method: 'POST' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(data.message, 'success');
                        await this.loadSchedules();
                    } else {
                        this.showAlert(data.error || 'Erro ao alterar status do agendamento', 'error');
                    }
                } catch (error) {
                    this.showAlert('Erro ao alterar status do agendamento', 'error');
                }
            }
            
            async deleteSchedule(scheduleId) {
                if (!confirm('Tem certeza que deseja deletar este agendamento?')) return;
                
                try {
                    const response = await fetch(`/api/schedules/${scheduleId}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(data.message, 'success');
                        await this.loadSchedules();
                    } else {
                        this.showAlert(data.error || 'Erro ao deletar agendamento', 'error');
                    }
                } catch (error) {
                    this.showAlert('Erro ao deletar agendamento', 'error');
                }
            }
            
            async loadHistory(page = 1) {
                try {
                    const response = await fetch(`/api/history?page=${page}&limit=20`);
                    const data = await response.json();
                    this.renderHistory(data.history);
                    this.renderHistoryPagination(data.pagination);
                } catch (error) {
                    console.error('Erro ao carregar histórico:', error);
                }
            }
            
            renderHistory(history) {
                const container = document.getElementById('historyList');
                
                if (history.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nenhuma atividade registrada</p>';
                    return;
                }
                
                let html = '';
                
                history.forEach(entry => {
                    const timestamp = new Date(entry.timestamp).toLocaleString('pt-BR');
                    const hasData = entry.data && Object.keys(entry.data).length > 0;
                    
                    html += `
                        <div class="history-item">
                            <div class="history-header">
                                <span class="history-type ${entry.type}">${entry.type.replace('_', ' ')}</span>
                                <span class="history-time">${timestamp}</span>
                            </div>
                            <div class="history-message">${entry.message}</div>
                            ${hasData ? `
                                <div class="history-data">
                                    ${JSON.stringify(entry.data, null, 2)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            renderHistoryPagination(pagination) {
                const container = document.getElementById('historyPagination');
                
                if (pagination.totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }
                
                let html = '<div style="display: flex; gap: 10px; justify-content: center; align-items: center;">';
                
                // Previous button
                if (pagination.page > 1) {
                    html += `<button class="btn btn-info" onclick="panel.loadHistory(${pagination.page - 1})">
                        <i class="fas fa-chevron-left"></i>
                        Anterior
                    </button>`;
                }
                
                // Page info
                html += `<span style="margin: 0 15px;">
                    Página ${pagination.page} de ${pagination.totalPages}
                </span>`;
                
                // Next button
                if (pagination.page < pagination.totalPages) {
                    html += `<button class="btn btn-info" onclick="panel.loadHistory(${pagination.page + 1})">
                        Próxima
                        <i class="fas fa-chevron-right"></i>
                    </button>`;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }
            
            addHistoryEntry(entry) {
                // Reload current page to show new entry
                if (this.currentTab === 'history') {
                    this.loadHistory(this.currentPage);
                }
                
                // Update stats
                const currentCount = parseInt(document.getElementById('historyCount').textContent);
                document.getElementById('historyCount').textContent = currentCount + 1;
            }
            
            async clearHistory() {
                if (!confirm('Tem certeza que deseja limpar todo o histórico? Esta ação não pode ser desfeita.')) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/history', { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(data.message, 'success');
                        await this.loadHistory();
                        document.getElementById('historyCount').textContent = '0';
                    } else {
                        this.showAlert(data.error || 'Erro ao limpar histórico', 'error');
                    }
                } catch (error) {
                    this.showAlert('Erro ao limpar histórico', 'error');
                }
            }
            
            toggleCheckboxItem(item) {
                const checkbox = item.querySelector('input[type="checkbox"], input[type="radio"]');
                
                if (checkbox.type === 'radio') {
                    // Handle radio buttons
                    document.querySelectorAll(`input[name="${checkbox.name}"]`).forEach(radio => {
                        radio.closest('.checkbox-item').classList.remove('checked');
                    });
                    checkbox.checked = true;
                    item.classList.add('checked');
                } else {
                    // Handle checkboxes
                    checkbox.checked = !checkbox.checked;
                    item.classList.toggle('checked', checkbox.checked);
                }
            }
            
            closeModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
                this.editingAd = null;
                this.editingSchedule = null;
            }
            
            handleDataUpdate(data) {
                // Handle real-time data updates from server
                switch (data.type) {
                    case 'groups':
                        this.renderGroups(data.data);
                        break;
                    case 'ads':
                        this.renderAds(data.data);
                        this.updateAdSelects(data.data);
                        break;
                    case 'schedules':
                        this.renderSchedules(data.data);
                        this.renderNextSends(data.data);
                        break;
                    default:
                        console.log('Data updated:', data);
                }
            }
            
            showAlert(message, type = 'info') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                
                const icon = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                }[type] || 'fas fa-info-circle';
                
                alertDiv.innerHTML = `
                    <i class="${icon}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; margin-left: auto; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                alertDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    min-width: 300px;
                    max-width: 500px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    animation: slideIn 0.3s ease-out;
                `;
                
                // Add animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(alertDiv);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }
        
        // Initialize panel when page loads
        let panel;
        document.addEventListener('DOMContentLoaded', () => {
            panel = new WhatsAppPanel();
        });
        
        // Handle modal clicks outside content
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                panel.closeModals();
            }
        });
    </script>
</body>
</html>